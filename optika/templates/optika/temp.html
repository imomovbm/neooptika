<script>
const container = document.getElementById("dioptriyaContainer");
const resultTable = document.getElementById("selectedTable");
const tbody = resultTable.querySelector("tbody");
const brandSelect = document.getElementById("brand");

const brandValues = {};

function setBrandValue(brand, dioLabel, value) {
  if (!brandValues[brand]) brandValues[brand] = {};
  brandValues[brand][dioLabel] = value;
}

function createItem(value) {
  const item = document.createElement("div");
  item.className = "dioptriya-item";

  const label = document.createElement("div");
  label.className = "dioptriya-label";
  label.textContent = value;

  const counter = document.createElement("div");
  counter.className = "counter";

  const minus = document.createElement("button");
  minus.type = "button";
  minus.textContent = "-";

  const input = document.createElement("input");
  input.type = "number";
  input.value = 0;
  input.min = 0;

  const plus = document.createElement("button");
  plus.type = "button";
  plus.textContent = "+";

  const onValueChange = () => {
    const currentBrand = brandSelect.value;
    const dioLabel = label.textContent.trim();
    const qty = Math.max(0, Number(input.value) || 0);

    input.value = qty; // normalize (no NaN, no negative)
    setBrandValue(currentBrand, dioLabel, qty);
    updateTable();
  };

  minus.addEventListener("click", () => {
    const next = Math.max(0, (Number(input.value) || 0) - 2);
    input.value = next;
    onValueChange();
  });

  plus.addEventListener("click", () => {
    input.value = (Number(input.value) || 0) + 2;
    onValueChange();
  });

  // âœ… THIS is what you were missing:
  input.addEventListener("input", onValueChange);

  counter.appendChild(minus);
  counter.appendChild(input);
  counter.appendChild(plus);

  item.appendChild(label);
  item.appendChild(counter);
  container.appendChild(item);
}

for (let i=-0.5; i>=-4; i-=0.25) createItem(i.toFixed(2));
for (let i=-4.5; i>=-10; i-=0.5) createItem(i.toFixed(2));
for (let i=-11; i>=-20; i-=1) createItem(i.toFixed(2));

function saveCurrentBrandValues() {
  const prevBrand = brandSelect.dataset.currentBrand;
  if (!prevBrand) return;

  if (!brandValues[prevBrand]) brandValues[prevBrand] = {};
  container.querySelectorAll(".dioptriya-item").forEach(item => {
    const dioLabel = item.querySelector(".dioptriya-label").textContent.trim();
    const input = item.querySelector("input");
    brandValues[prevBrand][dioLabel] = Math.max(0, Number(input.value) || 0);
  });
}

function updateTable() {
  tbody.innerHTML = "";
  const allSelected = [];

  Object.keys(brandValues).forEach(brand => {
    const dioOrder = Object.keys(brandValues[brand] || {});
    dioOrder.sort((a,b)=>parseFloat(b)-parseFloat(a));
    dioOrder.forEach(dio => {
      const qty = Number(brandValues[brand][dio]);
      if (qty > 0) allSelected.push({ nomi: brand, dioptriya: dio, qty });
    });
  });

  if (allSelected.length === 0) {
    resultTable.style.display = "none";
    return;
  }

  allSelected.forEach(s => {
    tbody.insertAdjacentHTML("beforeend",
      `<tr><td>${s.nomi}</td><td>${s.dioptriya}</td><td>${s.qty}</td></tr>`
    );
  });
  resultTable.style.display = "table";
}

brandSelect.addEventListener("change", () => {
  saveCurrentBrandValues();
  const currentBrand = brandSelect.value;
  brandSelect.dataset.currentBrand = currentBrand;

  container.querySelectorAll(".dioptriya-item").forEach(item => {
    const dioLabel = item.querySelector(".dioptriya-label").textContent.trim();
    const input = item.querySelector("input");
    input.value = brandValues[currentBrand]?.[dioLabel] || 0;
  });

  updateTable();
});

brandSelect.dataset.currentBrand = brandSelect.value;
brandSelect.dispatchEvent(new Event("change"));
</script>