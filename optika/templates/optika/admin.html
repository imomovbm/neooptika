{% extends "base.html" %}
{% load static %}
{% block title %}Admin{% endblock %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  h2 { text-align: center; color: #004080; margin: 15px 0; font-size: 20px; }
  .table-wrapper {
    max-width: 100%;
    margin: 0 auto;
    background: #fff;
    border-radius: 12px;
    overflow-x: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th, td { padding: 6px 8px; text-align: center; border: 1px solid #000; }
  th { background: #004080; color: #fff; }
  tr:nth-child(even) { background: #f8fbff; }
  tr:hover { background: #e6f0ff; }

  .action-btn {
    width: 32px; height: 32px; border: none; border-radius: 6px; cursor: pointer;
    display: inline-flex; justify-content: center; align-items: center; margin: 2px;
    font-size: 14px; color: #fff;
  }
  .view-btn { background: #0059b3; }
  .delete-btn { background: red; }

  .bulk-download,
  #shareTelegramBtn {
    display: flex; justify-content: center; align-items: center; gap: 8px;
    width: 220px; margin: 15px auto; color: #fff; font-weight: bold;
    font-size: 14px; padding: 10px 15px; border-radius: 8px; cursor: pointer;
    transition: 0.3s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    text-align: center;
  }
  .bulk-download { background: #004080; }
  .bulk-download:hover { background: #003366; transform: scale(1.05); }
  #shareTelegramBtn { background: #0088cc; }
  #shareTelegramBtn:hover { background: #0077b3; transform: scale(1.05); }

  .modal {
    display: none; position: fixed; top: 0; left: 0;
    width: 100%; height: 100%; background: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
  }
  .modal-content {
    background: #fff; padding: 15px; border-radius: 10px;
    max-width: 90%; width: 100%; max-height: 80%;
    overflow-y: auto; position: relative;
  }
  .close-btn {
    position: absolute; top: 10px; right: 15px;
    cursor: pointer; font-size: 18px; background: #ccc;
    border: none; border-radius: 50%;
    width: 28px; height: 28px;
  }
  @media(max-width:768px) {
    h2 { font-size: 18px; }
    th, td { font-size: 12px; padding: 4px 6px; }
    .action-btn { width: 28px; height: 28px; font-size: 12px; }
    .bulk-download, #shareTelegramBtn { width: 180px; font-size: 12px; padding: 8px; }
  }
</style>

<form id="antiForgeryForm">{% csrf_token %}</form>
<h2>Admin Panel - Arxivdagi Buyurtmalar</h2>

<div class="table-wrapper">
  <table id="adminTable">
    <thead>
      <tr>
        <th>Yuborilgan Sana</th>
        <th>Filial nomi</th>
        <th>Yuboruvchi</th>
        <th>Amallar</th>
      </tr>
    </thead>
    <tbody id="adminTableBody"></tbody>
  </table>
</div>

<div class="bulk-download" id="downloadAllBtn">
  <i class="fa-solid fa-download"></i> PDF ga yuklash
</div>
<div class="bulk-download" id="shareTelegramBtn">
  <i class="fa-brands fa-telegram"></i> Telegramga ulashish
</div>
<div class="bulk-download" id="clearAllBtn" style="background-color:#dc3545; color:white; cursor:pointer;">
  <i class="fa-solid fa-trash"></i> Barchasini tozalash
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <button class="close-btn" id="closeModal">×</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
  document.getElementById('clearAllBtn').onclick = async () => {
    if (!confirm("Barcha arxiv buyurtmalarini o‘chirmoqchimisiz?")) return;

    const res = await fetch('/Home/ClearAllArchives', {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF_TOKEN }
    });

    if (!res.ok) {
      alert("Xatolik yuz berdi!");
      return;
    }

    const data = await res.json();
    if (data.success) {
      alert(data.message);

      const table = document.getElementById('adminTable');
      if (table) table.remove();

      const container = document.querySelector('.table-wrapper');
      if (container) container.innerHTML = "<p>Barcha buyurtmalar o‘chirildi.</p>";
    } else {
      alert("Xatolik yuz berdi: " + data.message);
    }
  };

  document.getElementById('shareTelegramBtn').onclick = async () => {
    if (!confirm("PDF faylini Telegram orqali yuborishga ruxsat berasizmi?")) return;

    const res = await fetch('/Home/ShareAllArchivesTelegram', {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF_TOKEN }
    });

    const data = await res.json();
    if (data.success) {
      alert("✅ " + data.message);
      loadArchives();
    } else {
      alert("❌ Xatolik yuz berdi, qaytadan urinib ko‘ring");
    }
  };

  document.getElementById('downloadAllBtn').onclick = async () => {
    if (!confirm("PDF faylni yuklab olishni xohlaysizmi?")) return;

    const res = await fetch('/Home/DownloadAllArchivesPdf', {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF_TOKEN }
    });

    if (!res.ok) { alert("PDF yaratishda xatolik!"); return; }

    const blob = await res.blob();
    const pad = n => n.toString().padStart(2, '0');
    const now = new Date();
    const filename = `Buyurtma_${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}.pdf`;
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
    window.URL.revokeObjectURL(url);

    loadArchives();
  };

  const modal = document.getElementById('modal');
  const modalBody = document.getElementById('modalBody');
  const closeModal = document.getElementById('closeModal');
  closeModal.addEventListener('click', () => modal.style.display = 'none');

  async function loadArchives() {
    const res = await fetch('/Home/GetArchives');
    const archives = await res.json();

    const tbody = document.getElementById("adminTableBody");
    tbody.innerHTML = "";

    archives.forEach(a => {
      const tr = document.createElement("tr");

      const createdAt = a.createdAt || a.created_at;
      const filial = a.filial || a.Filial || "-";
      const fullName = a.userFullName || a.user_full_name || a.userFullName || "-";
      const isTelegramShared = a.isTelegramShared ?? a.is_telegram_shared ?? false;
      const isPdfDownloaded = a.isPdfDownloaded ?? a.is_pdf_downloaded ?? false;
      const id = a.id || a.Id;

      let icons = "";
      if (isTelegramShared) icons += ' <i class="fa-brands fa-telegram" style="color:#0088cc;" title="Telegramga yuborilgan"></i>';
      if (isPdfDownloaded) icons += ' <i class="fa-solid fa-file-pdf" style="color:red;" title="PDF yuklab olingan"></i>';

      tr.innerHTML = `
        <td>
          ${createdAt ? new Date(createdAt).toLocaleDateString() : ""}
          <br>
          ${icons}
        </td>
        <td>${filial}</td>
        <td>${fullName}</td>
        <td>
          <button class="view-btn action-btn" data-id="${id}" title="Ko‘rish"><i class="fa-solid fa-eye"></i></button>
          <button class="delete-btn action-btn" data-id="${id}" title="O‘chirish"><i class="fa-solid fa-trash"></i></button>
        </td>
      `;

      tbody.appendChild(tr);
    });

    attachEvents();
  }

  function attachEvents() {
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.onclick = async e => {
        const id = e.target.closest('button').dataset.id;
        const res = await fetch(`/Home/GetArchiveItems?archiveId=${id}`);
        const items = await res.json();

        modalBody.innerHTML = `
          <h3>Buyurtma Tafsiloti</h3>
          <div class="table-wrapper">
            <table style="width:100%; border-collapse: collapse; margin-top:10px;">
              <thead>
                <tr style="background:#004080; color:#fff;">
                  <th style="border:1px solid #000; padding:5px;">№</th>
                  <th style="border:1px solid #000; padding:5px;">Kategoriya</th>
                  <th style="border:1px solid #000; padding:5px;">Model</th>
                  <th style="border:1px solid #000; padding:5px;">Miqdor</th>
                </tr>
              </thead>
              <tbody id="modalTableBody"></tbody>
            </table>
          </div>
          <div id="showAllWrapper" style="margin-top:10px; text-align:center;"></div>
        `;

        const tbody = document.getElementById("modalTableBody");
        items.slice(0,10).forEach((i,index)=>{
          const tr=document.createElement("tr");
          tr.innerHTML = `
            <td style="border:1px solid #000; padding:5px;">${index+1}</td>
            <td style="border:1px solid #000; padding:5px;">${i.category ?? i.Category ?? "-"}</td>
            <td style="border:1px solid #000; padding:5px;">${i.model ?? i.Model ?? "-"}</td>
            <td style="border:1px solid #000; padding:5px;">${i.miqdor ?? i.Miqdor ?? 0}</td>`;
          tbody.appendChild(tr);
        });

        if(items.length>10){
          const btn = document.createElement("button");
          btn.textContent="Barchasini ko‘rsatish";
          btn.style.cssText="margin-top:10px; padding:5px 15px; background:#004080; color:#fff; border:none; cursor:pointer; border-radius:5px;";
          btn.onclick = () => {
            tbody.innerHTML="";
            items.forEach((i,index)=>{
              const tr=document.createElement("tr");
              tr.innerHTML = `
                <td style="border:1px solid #000; padding:5px;">${index+1}</td>
                <td style="border:1px solid #000; padding:5px;">${i.category ?? i.Category ?? "-"}</td>
                <td style="border:1px solid #000; padding:5px;">${i.model ?? i.Model ?? "-"}</td>
                <td style="border:1px solid #000; padding:5px;">${i.miqdor ?? i.Miqdor ?? 0}</td>`;
              tbody.appendChild(tr);
            });
            btn.remove();
          };
          document.getElementById("showAllWrapper").appendChild(btn);
        }

        modal.style.display='flex';
      };
    });

    document.querySelectorAll('.delete-btn').forEach(btn=>{
      btn.onclick = async e => {
        const id = e.target.closest('button').dataset.id;
        if(!confirm("Rostdan ham ushbu buyurtmani o‘chirmoqchimisiz?")) return;

        const res = await fetch(`/Home/DeleteArchive`,{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'X-CSRFToken': CSRF_TOKEN
          },
          body: JSON.stringify({ArchiveId:Number(id)})
        });

        const data = await res.json();
        if(data.success) e.target.closest('tr').remove();
        else alert("O‘chirishda xatolik yuz berdi");
      };
    });
  }

  loadArchives();
</script>
{% endblock %}
